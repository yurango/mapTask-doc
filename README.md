## **Целевая задача:** 
Интегрировать карту Москвы в движок UE5.5 в виде 3d локации. 
Запускать билд приложения на сервере, где будет производиться real-time рендер, реагирующий на действия юзера, которому изображение будет передаваться через UE Pixel Streaming.

## **Существующие продукты, решающие подобную задачу:** 
1. *Виртуальный Хельсинки* - студия Zoan создала интерактивный цифровой двойник Хельсинки, комбинируя Unreal Engine с **Cesium for Unreal** и Twinmotion для визуализации 3D-моделей города и IoT-данных в реальном времени​
2. *Цифровой двойник Сиэтла* - Tiltlabs разработала цифровую 3D-модель Сиэтла внутри Unreal Engine, используя **Cesium for Unreal** для геопривязки, а также компоненты Google 3D Tiles для детализации застройки и рельефа.
3. [*iNicosia*](https://cesium.com/blog/2023/03/30/smart-city-infrastructure-in-cesiumjs-connecting-nicosia/)  - Кипрский центр CYENS создал «умный» цифровой двойник Никосии на базе **CesiumJS** с интеграцией сенсорных данных, доступный через веб-интерфейс и Pixel Streaming для браузерного доступа к 3D-сцене города
4. Интерактивная карта Ноттингема - в Ноттингеме реализовали веб-портал для визуализации энергоэффективности жилых домов, совмещённый с 3D-моделью города на **CesiumJS** и Unreal Engine — пользователи могли в реальном времени оценивать данные об энергии прямо на 3D-сцене улиц и кварталов​.
5. [PublicTwin](https://cesium.com/blog/2024/07/09/drip-visual-enables-public-participation-in-urban-planning-with-cesium/?utm_source=chatgpt.com) — Нидерландская компания Drip Visual запустила **PublicTwin**, где граждане через браузер могли участвовать в градостроительных проектах Делфта: платформа стримит **Google Photorealistic 3D Tiles** в Unreal Engine по WebRTC, объединяя подробную 3D-геометрию со встроенными формами обратной связи.
6. [Мониторинг трафика в Ливерпуле (Австралия)](https://isprs-archives.copernicus.org/articles/XLVIII-4-2024/131/2024/isprs-archives-XLVIII-4-2024-131-2024.pdf?utm_source=chatgpt.com) - интеграция GIS-данных и потоков реального времени позволила моделировать транспорт и пользователей на городской карте в режиме реального времени внутри Unreal Engine, с возможностью стриминга изображения клиентам через Pixel Streaming.
7. [Лос-Анджелес: Hollywood Chamber of Commerce](https://www.planning.org/planning/2024/mar/smart-tech-to-help-build-your-citys-digital-twin/?utm_source=chatgpt.com) - компания CyberCity 3D предоставила данные о зданиях для Палаты торговли Голливуда; эти модели были импортированы в Unreal Engine и объединены с web-интерфейсом для презентаций проекта девелоперам и инвесторам, демонстрируя план развития района в интерактивном 3D​
8. [Цифровой двойник штатов Австралии](https://cesium.com/use-cases/digital-twins/?utm_source=chatgpt.com) - платформа Cesium поддерживает «тяжёлые» цифровые двойники крупных территорий, в том числе Виктории, Нового Южного Уэльса и Квинсленда (обслуживая до 78 % населения Австралии) — все сцены были реализованы через **Cesium for Unreal** с последующим стримингом геоданных и визуализацией через веб-клиент‍.
9. Городские проекты Esri и CityEngine - Esri и HOK продемонстрировали рабочий процесс импорта сцен из **ArcGIS CityEngine** в Unreal Engine с последующей заменой ассетов и публикацией через Pixel Streaming, что использовалось для совместного планирования и презентаций в городском планировании.
   
## **Сервисы решающие задачу стриминга Unreal приложений:** 
[**Vagon Streams**](https://forums.unrealengine.com/t/best-company-to-use-for-pixelstreaming/1139477?utm_source=chatgpt.com) — платформа для масштабируемого Pixel Streaming UE-проекта с упрощённой конфигурацией, рекомендованная в сообществе Unreal Engine как коммерческое решение для стриминга визуализации в браузер.  
[**Arcware** ](https://arcware.com/?utm_source=chatgpt.com)— предлагает end-to-end инфраструктуру с оптимизацией NVENC и низкими задержками для высококачественного стриминга UE-приложений через WebRTC‍​.  
[**Eagle 3D Streaming**](https://www.eagle3dstreaming.com/?utm_source=chatgpt.com) — self-serve платформа для развёртывания Pixel Streaming приложений в считанные минуты с глобальным CDN и встроенным matchmaker‍​.

## **Технологии на которые стоит обратить внимание:**
- **Для обработки геоданных**: QGIS, ArcGIS, CityEngine
- **Для серверной части**: NGINX для балансировки нагрузки, Docker для контейнеризации
- **Для мониторинга**: Prometheus + Grafana для отслеживания производительности
- **Для сжатия видеопотока**: настройки кодека H.264/H.265 с NVENC. Стоит заметить что для видеопотока существуют кодеки с более эффективным сжатием, но как они будут работать с pixel streaming UE неизвестно.
- **Для стриминга геоданных с визуализацией**: **Cesium for Unreal** — он стримит фотограмметрию, рельеф и 3D-здания в реальном времени.  
- **Для создания моделей:**  Esri CityEngine для создания процедурных городских моделей; Blender (с плагинами для импорта геоданных (Blender GIS); Houdini, Maya - для процедурной генерации. SpeedTree (для генерации растительности)
   *При использовании Cesium for Unreal - 3D Tiles, OSM Buildings.*
- **Для оптимизации**: Nanite/LOD; настраиваем параметры стриминга Cesium и WebRTC; ограничение рендеринга по активной области (Bounding box); при использовании стриминга - **occlusion culling**, чтобы не стримить скрытые объекты.  

## **Архитектура Pixel Streaming:**  
*В контексте задачи поставлено условие - использовать Pixel Streaming.*

1. Signalling Server** — Node.js-приложение, которое выполняет исключительно функцию организации обмена служебными сообщениями между запущенным на сервере Unreal-приложением и браузерами клиентов. Помогает клиентам и «стримерам» найти друг друга и договориться об установке прямого WebRTC-канала посредством обмена SDP-офферами/ответами и ICE-кандидатами (_адрес узла в сети_). В более сложных конфигурациях Signalling Server может осуществлять балансировку между несколькими «стриминг-серверами» и клиентами (matchmaker/SFU). Signalling Server может проверять и авторизовать подключения перед допуском к медиаканалу, что потенциально позволит обеспечить дополнительную степень безопасности.  
2. **Web Server** — доставляет клиентский HTML/JS-плеер через HTTP/HTTPS  
3. **UE-сервер** — запускает .sh/.exe с параметрами -PixelStreamingIP/-PixelStreamingPort и подключается к Signalling Server  
## **Решение:** 
 Нам необходимо выполнить подзадачи:
 1. Получить 3d сцены Москвы в UE из данных, полученных из ГИС.
 2. Настроить Pixel Streaming.
 3. Определить и настроить серверную инфраструктуру: провайдер для инстанса UE сервера (хост приложения и UE pixel streaming); провайдер для Signalling Server. 
 4. Запрограммировать интерактивные элементы сцены.
 5. Реализовать визуальный интерфейс.
 6. Сделать билд и деплой проекта под linux.
 7. Протестировать решение в разных условиях. Важно сохранить стабильно высокий latency сетевого отклика и fps серверной машины.
### **Технический процесс:**  
_Обмен SDP и ICE:_

1.       Клиент в браузере генерирует SDP-оффер (описание мультимедиа-сессии) и ICE-кандидаты (IP/порт-адреса) и отправляет их на сервер сигнализации _(использовать WebSocket для доставки сообщений; WebSocket-канал позволяет обойти NAT-ограничения и настроить STUN/TURN реле при необходимости)_.
2.       Сервер перенаправляет это сообщение на Unreal-сервер, который в ответ создаёт SDP-ответ и свои ICE-кандидаты, затем возвращает обратно клиенту через Signalling Server.
3.       После успешного обмена кандидатов и SDP браузер и UE-приложение устанавливают прямое P2P-соединение и начинают передавать закодированный видеопоток (NVENC/AMF) без участия Signalling Server


-----
## Разбор подзадач:

**Основные опции для выполнения подзадачи 1 - 3d cцена**:
	> **Стриминг 3d локации от провайдера данных** посредством 3d tiles с облаком точек
	> **Процедурная генерация** - сложная реализация, значительно проще чем при стриминге внедрение дополнительных функций интеракций с 3d моделями, возможно создание более детализированных моделей, отсутствует плата за поддержку работы ассета, без учёта возможной стоимости локального хранения)
	> **AI генерация 3d моделей или облака точек по картографическим данным** - самое новое и пока очень трудное для качественного внедрения решение. В перспективе может очень сильно оптимизировать затраты на создание качественных моделей, но пока технология находится в стадии активной разработки.  
	
	 Для получения картографической информации используем открытые источники геоданных (OSM) или коммерческие решения (Яндекс, 2GIS).  
	
**Основные опции для выполнения подзадачи 3 - сервер:
	> Выбор точки развёртывания следует дополнительно изучить (Глобальный стандарт для задачи - AWS, Azure). С учётом реалий действительности - стандартные решения могут не подойти. 


